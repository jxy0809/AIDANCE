<!-- miniprogram/pages/chat/chat.wxml (saved as .html) -->
<view class="container">
  <!-- Header -->
  <view class="header glass-nav">
    <text class="header-title">AIDANCE</text>
  </view>

  <!-- Messages Area -->
  <scroll-view 
    class="messages-area" 
    scroll-y="true" 
    scroll-into-view="{{scrollIntoView}}"
    scroll-with-animation="true"
    enable-flex="true"
    style="padding-bottom: {{bottomPadding}}px;"
    bindtap="onBlur"
  >
    <block wx:for="{{messages}}" wx:key="id">
      <view class="message-wrapper {{item.role === 'user' ? 'user-wrapper' : 'model-wrapper'}}" id="msg-{{index}}">
        
        <!-- Bot Icon -->
        <block wx:if="{{item.role !== 'user'}}">
          <view class="avatar {{item.isAlert ? 'avatar-alert' : 'avatar-bot'}}">
            <image wx:if="{{!item.isAlert}}" src="/assets/chat-active.png" mode="aspectFit" class="avatar-icon"></image>
            <text wx:else>‚ö†Ô∏è</text>
          </view>
        </block>

        <!-- Bubble -->
        <view class="bubble {{item.role === 'user' ? 'bubble-user' : (item.isAlert ? 'bubble-alert' : 'bubble-model')}}">
          <!-- Images -->
          <view wx:if="{{item.images && item.images.length > 0}}" class="image-grid">
            <block wx:for="{{item.images}}" wx:key="*this" wx:for-item="img">
              <image src="{{img}}" mode="aspectFill" class="msg-image" bindtap="previewImage" data-src="{{img}}"></image>
            </block>
          </view>
          
          <!-- Text -->
          <text user-select="true" class="message-text">{{item.content}}</text>
        </view>
      </view>
      
      <!-- Timestamp -->
      <view class="timestamp {{item.role === 'user' ? 'time-right' : 'time-left'}}">
        {{item.timeStr}}
      </view>
    </block>

    <!-- Typing Indicator -->
    <view wx:if="{{isTyping}}" class="message-wrapper model-wrapper">
      <view class="avatar avatar-bot">
        <image src="/assets/chat-active.png" mode="aspectFit" class="avatar-icon"></image>
      </view>
      <view class="bubble bubble-model typing-bubble">
        <view class="dot dot-1"></view>
        <view class="dot dot-2"></view>
        <view class="dot dot-3"></view>
      </view>
    </view>

    <!-- Anchor for scrolling -->
    <view id="bottom-anchor" style="height: 1px;"></view>
  </scroll-view>

  <!-- Input Area -->
  <view class="input-container glass-nav" style="bottom: {{keyboardHeight}}px;">
    <!-- Pending Images Preview -->
    <scroll-view wx:if="{{pendingImages.length > 0}}" scroll-x="true" class="preview-scroll">
      <view class="preview-list">
        <block wx:for="{{pendingImages}}" wx:key="*this">
          <view class="preview-item">
            <image src="{{item}}" mode="aspectFill" class="preview-img"></image>
            <view class="preview-close" catchtap="removeImage" data-index="{{index}}">√ó</view>
          </view>
        </block>
      </view>
    </scroll-view>

    <view class="input-bar">
      <!-- Voice/Mic Button (Placeholder for now) -->
      <view class="icon-btn {{isListening ? 'btn-listening' : 'btn-normal'}}" bindtap="toggleListening">
        <text class="iconfont">üé§</text>
      </view>

      <!-- Text Input -->
      <input 
        class="text-input" 
        type="text" 
        confirm-type="send"
        placeholder="{{isListening ? 'Ê≠£Âú®ËÅÜÂê¨...' : 'ËæìÂÖ•Ê∂àÊÅØ...'}}" 
        placeholder-class="placeholder-style"
        value="{{input}}" 
        bindinput="handleInput"
        bindconfirm="handleSend"
        bindfocus="onFocus"
        bindblur="onBlur"
        adjust-position="{{false}}"
      />

      <!-- Image Upload Button -->
      <view class="icon-btn btn-normal" bindtap="chooseImage">
        <text class="iconfont">üì∑</text>
      </view>

      <!-- Send Button -->
      <view class="icon-btn {{canSend ? 'btn-primary' : 'btn-disabled'}}" bindtap="handleSend">
        <text class="iconfont">‚û§</text>
      </view>
    </view>
  </view>
</view>